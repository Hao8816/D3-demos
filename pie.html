<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>D3学习</title>
    <script src="lib/d3/d3.v3.min.js"></script>
    <style>


    </style>

</head>
<body>

<div id="pie_chart"></div>
<script type="text/javascript">

    var width = 500;
    var height = 500;

    var dataset = [
        ['华为','90'],
        ['华为1','30'],
        ['华为2','40'],
        ['华为3','50'],
        ['华为4','60'],
        ['华为5','70'],
        ['华为6','110'],
        ['华为7','30'],
        ['华为21','30'],
        ['华为22','30'],
        ['华为23','30'],
        ['华为24','30'],
        ['华为25','30'],
        ['华为26','30'],
        ['华为27','30'],
        ['华为28','30'],
        ['华为29','30'],
        ['华为30','30'],
        ['华为31','30'],
        ['华为32','30'],
        ['华为8','50'],
        ['华为9','70'],
        ['华为11','60'],
        ['华为12','30'],
    ]

    var colors = d3.range(100).map(d3.scale.category20())

    var outerRadius = width/3
    var innerTadius = 0
    var arc = d3.svg.arc().innerRadius(innerTadius).outerRadius(outerRadius)

    var pie = d3.layout.pie().value(function(d){return d[1]})
    var pie_data = pie(dataset)
    // 清空画布
    var svg = d3.select("#pie_chart").append("svg").attr("width",width).attr("height",height)
    var arcs = svg.selectAll("g")
            .data(pie_data)
            .enter()
            .append("g")
            .attr("transform","translate("+(width/2)+","+(height/2)+")")
            .on("mouseover",function(d,i){
                d3.select(this).attr('fill','red')
            })
            .on("mouseout",function(d,i){
                d3.select(this).transition().duration(500).attr('fill','#666666')
            })
    arcs.append("path").attr("fill",function(d,i){return colors[i]}).attr('d',function(d){return arc(d)})

    var label_points = [];
    arcs.append('text').attr('class','pie-label').text(function(d){
        var x = arc.centroid(d)[0]*2.4
        var y = arc.centroid(d)[1]*2.4
        label_points.push({
            name : d.data[0],
            x : x,
            y : y
        })
    }).attr('fill','#ffffff')

    // 将label_points拆分成两部分， x>0 和 x <0

    var left_points = [];
    var right_points = [];
    label_points.forEach(function(d){
        if (d.x >0){
            right_points.push(d)
        }else{
            left_points.push(d)
        }
    });

    // 排序操作
    left_points.sort(function(a,b){
        return a.y - b.y
    })
    right_points.sort(function(a,b){
        return a.y - b.y
    })

    var point_hash = {}
    // 上下点之间的距离
    left_points.forEach(function(d,index){
        if (index==0){
            point_hash[d.name] = [d.x, d.y]
        }else{
            // 比较
            if (d.y - left_points[index-1].y < 20){
                d.y = left_points[index-1].y + 20
            }
            point_hash[d.name] = [d.x, d.y]

        }
    })

    right_points.forEach(function(d,index){
        if (index==0){
            point_hash[d.name] = [d.x, d.y]
        }else{
            // 比较
            if (d.y - right_points[index-1].y < 20){
                d.y = left_points[index-1].y + 20
            }
            // 如果x距离太近，需要调整一下
            point_hash[d.name] = [d.x, d.y]
        }
    })

    arcs.append('text').attr('transform',function(d){
        console.log('xxx',d.data[0])
        var points = point_hash[d.data[0]];
        console.log(points)
        var x = points[0];
        var y = points[1];
        if(x<0){
            if (Math.abs(x)+70>width/2){
                x = -(width/2)+70
            }
        }else{
            if (Math.abs(x)+80>=width/2){
                x = width/2-80
            }
        }
        return "translate("+x+","+y+")"

    }).attr('text-anchor',function(d){
        var x = arc.centroid(d)[0]*2.4
        console.log(d)
        if (x>0){
            return 'start'
        }else{
            return 'end'
        }
    }).attr('font-size','12px').text(function(d){
        var percent = Number(d.value)/d3.sum(dataset,function(d){return d[1]})*100
        return d.data[0] + '' + percent.toFixed(1)+'%'
    })

    arcs.append("line").attr('stroke','#666666')
            .attr('x1',function(d){return arc.centroid(d)[0]*2})
            .attr('y1',function(d){return arc.centroid(d)[1]*2})
            .attr('x2',function(d){
                var points = point_hash[d.data[0]];
                console.log(points)
                var x = points[0];
                return x
            })
            .attr('y2',function(d){
                var points = point_hash[d.data[0]];
                console.log(points)
                var y = points[1];

                return y
            })



</script>
</body>
</html>

